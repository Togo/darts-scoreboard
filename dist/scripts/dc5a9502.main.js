var ViewDatas=function(){var a=this;this.games=[101,301,501],this.gameIndex=0,this.players=ko.observableArray([]),this.thrown=ko.observable(0),this.switchViewIndex=ko.observable(0),this.switchToDoubleOut=ko.observable(!1),this.currentPlayerIndex=0,this.nextPlayerToThrowFirst=1,this.jumpToNextPlayer=function(b){var c,d;a.updateAvg(b),b.require=b.score(),c=a.currentPlayerIndex+1,c>=a.players().length&&(c=0),a.thrown(0),b.status(0),d=a.players()[c],d.status(1),a.currentPlayerIndex=c},this.handleThrow=function(b,c){var d;d=a.getCurrentPlayer(),d.history.push(parseInt(b)),d.score()<0?(a.thrown(a.thrown()+1),d.history.splice(0-a.thrown(),a.thrown()),a.jumpToNextPlayer(d)):0==d.score()?0==a.switchToDoubleOut()?(a.turnScore(d),a.winner(d)):1==a.switchToDoubleOut()&&("d"==c[0]||"Bull"==c?(a.turnScore(d),a.winner(d)):(a.thrown(a.thrown()+1),d.history.splice(0-a.thrown(),a.thrown()),a.jumpToNextPlayer(d))):1==a.switchToDoubleOut()&&1==d.score()?(a.thrown(a.thrown()+1),d.history.splice(0-a.thrown(),a.thrown()),a.jumpToNextPlayer(d)):2==a.thrown()?(a.turnScore(d),a.jumpToNextPlayer(d)):a.thrown(a.thrown()+1)},this.winner=function(b){return 1==a.players().length?void b.victories(b.victories()+1):(b.highestGameShot(b.require),a.updateAvg(b),ko.utils.arrayForEach(a.players(),function(a){a.status(2),a.history([]),a.turnHistory([]),a.require=a.score()}),a.thrown(0),a.currentPlayerIndex=a.nextPlayerToThrowFirst,a.players()[a.currentPlayerIndex].status(1),a.nextPlayerToThrowFirst++,a.nextPlayerToThrowFirst>=a.players().length&&(a.nextPlayerToThrowFirst=0),void b.victories(b.victories()+1))},this.turnScore=function(b){for(var c=a.thrown()+1,d=b.history.slice(-c),e=0,f=0;c>f;f++)e+=d[f];b.turnHistory.push(e),b.allTurnHistory.push(e),console.log("...tHis: "+b.turnHistory().toString()),console.log("allTHis: "+b.allTurnHistory().toString())},this.updateAvg=function(a){var b=a.turnHistory().reduce(function(a,b){return a+b},0);a.avg((b/a.turnHistory().length).toFixed(2))},this.swapScore=function(){a.gameIndex++,a.gameIndex>=a.games.length&&(a.gameIndex=0),ko.utils.arrayForEach(a.players(),function(a){a.status(2),a.history([]),a.turnHistory([]),a.require=a.score()})},this.switchDoubleOut=function(){1==a.switchToDoubleOut()?(console.log(a.switchToDoubleOut()),a.switchToDoubleOut(!1)):0==a.switchToDoubleOut()&&(console.log(a.switchToDoubleOut()),a.switchToDoubleOut(!0)),console.log("asd")},this.switchView=function(){var b,c=$("#switchable").attr("href");1==a.switchViewIndex()?(b=c.replace("view","main"),a.switchViewIndex(0)):0==a.switchViewIndex()&&(b=c.replace("main","view"),a.switchViewIndex(1)),$("#switchable").attr("href",b)},this.undo=function(){0==a.thrown()?(a.getCurrentPlayer().status(2),a.currentPlayerIndex--,a.currentPlayerIndex<0&&(a.currentPlayerIndex=a.players().length-1),a.getCurrentPlayer().history.splice(-3,3),a.getCurrentPlayer().turnHistory.splice(-1,1),a.getCurrentPlayer().allTurnHistory.splice(-1,1)):(a.getCurrentPlayer().history.splice(0-a.thrown(),a.thrown()),a.thrown(0)),a.getCurrentPlayer().status(1)},this.getCurrentPlayer=function(){return a.players()[a.currentPlayerIndex]}},viewDatas=new ViewDatas,playerModel=function(a,b,c,d){this.name=a,this.status=ko.observable(b),this.victories=ko.observable(d||0),this.avg=ko.observable(0),this.history=ko.observableArray([]),this.require=c,this.score=ko.computed(function(){return viewDatas.games[viewDatas.gameIndex]-this.history().reduce(function(a,b){return a+b},0)},this),this.turnHistory=ko.observableArray([]),this.allTurnHistory=ko.observableArray([]),this.highestScore=ko.computed(function(){return this.allTurnHistory().reduce(function(a,b){return a>b?a:b},0)},this),this.highestGameShot=ko.observable(0)};ko.bindingHandlers.status={update:function(a,b,c,d,e){var a,f=b(),g=ko.unwrap(f);a=$(a).parent().children("span.name"),1==g?a.css("background-color","#AFE1AB"):0==g?a.css("background-color",""):a.css("background-color","")}},$(function(){var a,b=0;ko.applyBindings({players:viewDatas.players,thrown:viewDatas.thrown,_switch:viewDatas.switchViewIndex,highestGameShotAll:ko.computed(function(){return viewDatas.players().reduce(function(a,b){return b.highestGameShot()>a?b.highestGameShot():a},0)},this),_switch_double:viewDatas.switchToDoubleOut}),a=viewDatas.games[viewDatas.gameIndex],viewDatas.players.push(new playerModel("Márki",1,a)),viewDatas.players.push(new playerModel("Csé",2,a)),$("#switch_double_btn").click(function(){viewDatas.switchDoubleOut()}),$("#switch_view_btn").click(function(){viewDatas.switchView()}),$("#zero").click(function(){viewDatas.handleThrow(0)}),$("#up").click(function(){viewDatas.swapScore()}),$("#undo").click(function(){viewDatas.undo()}),$("#dartboard #areas g").children().click(function(){var a,c,d,e=this;a=$(this).attr("id"),"rgb(255, 255, 0)"!=$(this).css("fill")&&(d=$(this).css("fill"),b++,1===b?($(this).css("fill","yellow"),singleClickTimer=setTimeout(function(){b=0,$(e).css("fill",d)},250)):2===b&&(clearTimeout(singleClickTimer),b=0),c=a.substring(1),"d"==a[0]&&(c=2*c),"t"==a[0]&&(c=3*c),"Outer"==a&&(c=25),"Bull"==a&&(c=50),viewDatas.handleThrow(c,a))})});